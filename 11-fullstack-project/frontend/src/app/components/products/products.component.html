<div class="container">
  @if (!authService.isLoggedIn()) {
    <div class="info-message">
      ‚ÑπÔ∏è Puedes comprar sin registrarte, pero <a routerLink="/login">inicia sesi√≥n</a> o <a routerLink="/register">reg√≠strate</a> para obtener <strong>descuentos exclusivos</strong> y <strong>puntos de recompensa</strong> üéÅ
    </div>
  }

  <div class="header">
    <h2>üì¶ {{ authService.isAdmin() ? 'Gesti√≥n de Productos' : 'Cat√°logo de Productos' }}</h2>
    @if (authService.isAdmin()) {
      <button class="btn-add" (click)="showForm = !showForm">
        {{ showForm ? '‚ùå Cancelar' : '‚ûï Nuevo Producto' }}
      </button>
    }
  </div>

  @if (showForm) {
    <div class="form-card">
      <h3>{{ isEditing ? 'Editar Producto' : 'Nuevo Producto' }}</h3>
      <form (ngSubmit)="saveProduct()">
        <div class="form-group">
          <label>Nombre:</label>
          <input type="text" [(ngModel)]="currentProduct.name" name="name" required>
        </div>
        <div class="form-group">
          <label>Descripci√≥n:</label>
          <textarea [(ngModel)]="currentProduct.description" name="description" rows="3" required></textarea>
        </div>
        <div class="form-group">
          <label>URL de Imagen:</label>
          <input type="url" [(ngModel)]="currentProduct.image_url" name="image_url" placeholder="https://ejemplo.com/imagen.jpg">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Precio:</label>
            <input type="number" [(ngModel)]="currentProduct.price" name="price" step="0.01" required>
          </div>
          <div class="form-group">
            <label>Stock:</label>
            <input type="number" [(ngModel)]="currentProduct.stock" name="stock" required>
          </div>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn-save">üíæ Guardar</button>
          <button type="button" class="btn-cancel" (click)="cancelEdit()">‚ùå Cancelar</button>
        </div>
      </form>
    </div>
  }

  @if (loading) {
    <div class="loading">Cargando productos...</div>
  }

  @if (error) {
    <div class="error">{{ error }}</div>
  }

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Imagen</th>
          <th>ID</th>
          <th>Categor√≠a</th>
          <th>Nombre</th>
          <th>Descripci√≥n</th>
          <th>Precio</th>
          <th>Stock</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        @for (product of products; track product.id) {
          <tr>
            <td>
              @if (product.image_url) {
                <img [src]="product.image_url" [alt]="product.name" class="product-image">
              } @else {
                <div class="no-image">üì¶</div>
              }
            </td>
            <td>{{ product.id }}</td>
            <td>
              @if (product.category_name) {
                <span class="category-badge">{{ product.category_name }}</span>
              } @else {
                <span class="category-badge no-category">Sin categor√≠a</span>
              }
            </td>
            <td>{{ product.name }}</td>
            <td>{{ product.description }}</td>
            <td>\${{ product.price | number:'1.2-2' }}</td>
            <td>
              <span [class.low-stock]="product.stock < 10">{{ product.stock }}</span>
            </td>
            <td class="actions">
              <!-- Todos pueden agregar al carrito -->
              <button class="btn-cart" (click)="addToCart(product)">üõí Agregar</button>

              <!-- Solo admin puede editar y eliminar productos -->
              @if (authService.isAdmin()) {
                <button class="btn-edit" (click)="editProduct(product)">‚úèÔ∏è Editar</button>
                <button class="btn-delete" (click)="deleteProduct(product.id!)">üóëÔ∏è Eliminar</button>
              }
            </td>
          </tr>
        }
        @empty {
          <tr>
            <td colspan="7" class="no-data">No hay productos registrados</td>
          </tr>
        }
      </tbody>
    </table>
  </div>
</div>

<!-- Modal para agregar al carrito -->
@if (showCartModal && selectedProduct) {
  <div class="modal-overlay" (click)="closeCartModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>üõí Agregar al Carrito</h3>
        <button class="btn-close" (click)="closeCartModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="product-preview">
          @if (selectedProduct.image_url) {
            <img [src]="selectedProduct.image_url" [alt]="selectedProduct.name" class="preview-image">
          } @else {
            <div class="preview-no-image">üì¶</div>
          }
          <div class="preview-info">
            <h4>{{ selectedProduct.name }}</h4>
            <p class="preview-description">{{ selectedProduct.description }}</p>
            <p class="preview-price">${{ selectedProduct.price | number:'1.2-2' }}</p>
            <p class="preview-stock">Stock disponible: {{ selectedProduct.stock }}</p>
          </div>
        </div>

        <div class="quantity-selector">
          <label>Cantidad:</label>
          <div class="quantity-controls-modal">
            <button (click)="decreaseQuantity()" class="btn-qty-modal" [disabled]="quantityToAdd <= 1">‚àí</button>
            <input type="number" [(ngModel)]="quantityToAdd" name="quantity" min="1" [max]="selectedProduct.stock" class="quantity-input">
            <button (click)="increaseQuantity()" class="btn-qty-modal" [disabled]="quantityToAdd >= selectedProduct.stock">+</button>
          </div>
          <p class="total-preview">Total: ${{ (selectedProduct.price * quantityToAdd) | number:'1.2-2' }}</p>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel-modal" (click)="closeCartModal()">Cancelar</button>
        <button class="btn-confirm-modal" (click)="confirmAddToCart()">Agregar al Carrito</button>
      </div>
    </div>
  </div>
}
